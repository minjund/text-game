<template>
  <div class="min-h-screen bg-slate-900 p-8">
    <div class="max-w-4xl mx-auto space-y-12">
      <h1 class="text-4xl font-bold text-white text-center mb-12">
        ê²Œì„ ì• ë‹ˆë©”ì´ì…˜ ì˜ˆì‹œ
      </h1>

      <!-- 1. ëª¨ë‹¬ ì¤Œì¸/ì¤Œì•„ì›ƒ -->
      <section class="space-y-4">
        <h2 class="text-2xl font-bold text-purple-400">1. ëª¨ë‹¬ ì¤Œì¸/ì¤Œì•„ì›ƒ</h2>
        <button
          @click="showZoomModal = !showZoomModal"
          class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
        >
          ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        </button>

        <div
          v-if="showZoomModal"
          class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
          @click="closeZoomModal"
        >
          <div
            ref="zoomModalRef"
            @click.stop
            class="bg-slate-800 rounded-xl p-8 max-w-md border-2 border-purple-500"
          >
            <h3 class="text-2xl font-bold text-white mb-4">ì¤Œ ì• ë‹ˆë©”ì´ì…˜ ëª¨ë‹¬</h3>
            <p class="text-slate-300 mb-4">
              ì´ ëª¨ë‹¬ì€ GSAPì˜ back.out ì´ì§•ìœ¼ë¡œ íŠ•ê¸°ë©´ì„œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤!
            </p>
            <button
              @click="closeZoomModal"
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
            >
              ë‹«ê¸°
            </button>
          </div>
        </div>
      </section>

      <!-- 2. ì–‘í”¼ì§€ í¼ì¹˜ê¸° -->
      <section class="space-y-4">
        <h2 class="text-2xl font-bold text-purple-400">2. ì–‘í”¼ì§€ í¼ì¹˜ê¸°/ì ‘ê¸°</h2>
        <button
          @click="showParchment = !showParchment"
          class="px-6 py-3 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition"
        >
          ì–‘í”¼ì§€ í† ê¸€
        </button>

        <div
          v-if="showParchment"
          ref="parchmentRef"
          class="bg-amber-50 rounded-lg p-8 border-4 border-amber-800 shadow-2xl relative overflow-hidden"
          style="background-image: url('data:image/svg+xml,%3Csvg width=\\'100\\' height=\\'100\\' xmlns=\\'http://www.w3.org/2000/svg\\'%3E%3Cfilter id=\\'noise\\'%3E%3CfeTurbulence baseFrequency=\\'0.9\\' /%3E%3C/filter%3E%3Crect width=\\'100\\' height=\\'100\\' filter=\\'url(%23noise)\\' opacity=\\'0.05\\' /%3E%3C/svg%3E')"
        >
          <div class="parchment-content">
            <h3 class="text-2xl font-serif font-bold text-amber-900 mb-4">
              ì™•ì‹¤ ì¹™ë ¹
            </h3>
          </div>
          <div class="parchment-content">
            <p class="text-amber-800 leading-relaxed mb-3">
              ì§ì€ ì´ ë•…ì˜ ëª¨ë“  ë°±ì„±ì—ê²Œ ì„ í¬í•˜ë…¸ë¼.
            </p>
          </div>
          <div class="parchment-content">
            <p class="text-amber-800 leading-relaxed mb-3">
              ìš©ë§¹í•œ ì¥ìˆ˜ë“¤ì´ì—¬, ì•ìœ¼ë¡œ ë‚˜ì„œë¼!
            </p>
          </div>
          <div class="parchment-content">
            <p class="text-amber-700 text-sm italic text-right mt-6">
              - ì™•ì˜ ì¸ì¥ -
            </p>
          </div>
        </div>
      </section>

      <!-- 3. ë²„íŠ¼ í„ìŠ¤ & ìƒ¤ì¸ íš¨ê³¼ -->
      <section class="space-y-4">
        <h2 class="text-2xl font-bold text-purple-400">3. ë²„íŠ¼ í´ë¦­ íš¨ê³¼</h2>
        <div class="flex gap-4">
          <button
            ref="pulseButtonRef"
            @click="handlePulse"
            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
          >
            í„ìŠ¤ íš¨ê³¼
          </button>
          <button
            ref="shineButtonRef"
            @click="handleShine"
            class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg relative overflow-hidden"
          >
            ìƒ¤ì¸ íš¨ê³¼
          </button>
        </div>
      </section>

      <!-- 4. ì¹´ë“œ ë’¤ì§‘ê¸° -->
      <section class="space-y-4">
        <h2 class="text-2xl font-bold text-purple-400">4. ì¹´ë“œ ë’¤ì§‘ê¸°</h2>
        <button
          @click="handleCardFlip"
          class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
        >
          ì¹´ë“œ ë’¤ì§‘ê¸°
        </button>

        <div class="flex justify-center">
          <div
            ref="cardRef"
            class="w-48 h-64 rounded-xl shadow-2xl relative preserve-3d cursor-pointer"
            style="perspective: 1000px; transform-style: preserve-3d"
            @click="handleCardFlip"
          >
            <div
              class="absolute inset-0 bg-gradient-to-br from-purple-600 to-blue-600 rounded-xl flex items-center justify-center"
              :class="{ 'opacity-0': isCardFlipped, 'opacity-100': !isCardFlipped }"
            >
              <span class="text-6xl">ğŸ´</span>
            </div>
            <div
              class="absolute inset-0 bg-gradient-to-br from-amber-500 to-red-600 rounded-xl flex items-center justify-center"
              :class="{ 'opacity-100': isCardFlipped, 'opacity-0': !isCardFlipped }"
            >
              <span class="text-6xl">âš”ï¸</span>
            </div>
          </div>
        </div>
      </section>

      <!-- 5. ë¦¬ì†ŒìŠ¤ ì¹´ìš´í„° ì• ë‹ˆë©”ì´ì…˜ -->
      <section class="space-y-4">
        <h2 class="text-2xl font-bold text-purple-400">5. ë¦¬ì†ŒìŠ¤ ì¹´ìš´í„°</h2>
        <button
          @click="animateCounter"
          class="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition"
        >
          ê³¨ë“œ íšë“!
        </button>

        <div class="bg-slate-800 rounded-lg p-6 border border-yellow-500">
          <div class="flex items-center justify-between">
            <span class="text-yellow-400 font-bold">ğŸ’° ê³¨ë“œ:</span>
            <span ref="counterRef" class="text-4xl font-bold text-yellow-400">
              {{ currentGold.toLocaleString() }}
            </span>
          </div>
        </div>
      </section>

      <!-- 6. ì „íˆ¬ ì´í™íŠ¸ -->
      <section class="space-y-4">
        <h2 class="text-2xl font-bold text-purple-400">6. ì „íˆ¬ ì´í™íŠ¸</h2>
        <div class="flex gap-4">
          <button
            @click="handleShake"
            class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
          >
            í”ë“¤ë¦¼
          </button>
          <button
            @click="handleFlash"
            class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition"
          >
            í”Œë˜ì‹œ
          </button>
          <button
            @click="handleCritical"
            class="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition"
          >
            í¬ë¦¬í‹°ì»¬!
          </button>
        </div>

        <div
          ref="battleTargetRef"
          class="bg-slate-800 rounded-lg p-8 border-2 border-red-500 text-center"
        >
          <span class="text-6xl">ğŸ›¡ï¸</span>
          <p class="text-white mt-4 text-xl font-bold">íƒ€ê²Ÿ</p>
        </div>
      </section>

      <!-- 7. Auto Animate ë¦¬ìŠ¤íŠ¸ -->
      <section class="space-y-4">
        <h2 class="text-2xl font-bold text-purple-400">7. ìë™ ë¦¬ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜</h2>
        <div class="flex gap-4">
          <button
            @click="addItem"
            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
          >
            ì•„ì´í…œ ì¶”ê°€
          </button>
          <button
            @click="removeItem"
            class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
          >
            ì•„ì´í…œ ì œê±°
          </button>
        </div>

        <div
          ref="listRef"
          class="space-y-2 bg-slate-800 rounded-lg p-6 min-h-[200px]"
        >
          <div
            v-for="item in items"
            :key="item.id"
            class="bg-purple-600 text-white p-4 rounded-lg flex items-center justify-between"
          >
            <span>{{ item.name }}</span>
            <button
              @click="removeSpecificItem(item.id)"
              class="text-red-300 hover:text-red-500"
            >
              âŒ
            </button>
          </div>
        </div>
      </section>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, nextTick } from 'vue'
import { useAutoAnimate } from '@formkit/auto-animate/vue'
import {
  useModalZoom,
  useParchmentUnfold,
  useButtonPulse,
  useCardFlip,
  useCounterAnimation,
  useBattleEffects,
} from '~/composables/useAnimations'

// Refs
const zoomModalRef = ref<HTMLElement>()
const parchmentRef = ref<HTMLElement>()
const pulseButtonRef = ref<HTMLElement>()
const shineButtonRef = ref<HTMLElement>()
const cardRef = ref<HTMLElement>()
const counterRef = ref<HTMLElement>()
const battleTargetRef = ref<HTMLElement>()
const [listRef] = useAutoAnimate()

// States
const showZoomModal = ref(false)
const showParchment = ref(false)
const isCardFlipped = ref(false)
const currentGold = ref(1000)
const items = ref([
  { id: 1, name: 'ì¥ìˆ˜ - ì¡°ìš´' },
  { id: 2, name: 'ì¥ìˆ˜ - ê´€ìš°' },
  { id: 3, name: 'ì¥ìˆ˜ - ì¥ë¹„' },
])

// Composables
const { openModal, closeModal } = useModalZoom()
const { unfold, fold } = useParchmentUnfold()
const { pulse, shine } = useButtonPulse()
const { flip, flipBack } = useCardFlip()
const { animateValue } = useCounterAnimation()
const { shake, flash, criticalHit } = useBattleEffects()

// 1. ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜
watch(showZoomModal, async (newVal) => {
  if (newVal) {
    await nextTick()
    if (zoomModalRef.value) {
      openModal(zoomModalRef.value)
    }
  }
})

const closeZoomModal = () => {
  if (zoomModalRef.value) {
    closeModal(zoomModalRef.value, () => {
      showZoomModal.value = false
    })
  }
}

// 2. ì–‘í”¼ì§€ ì• ë‹ˆë©”ì´ì…˜
watch(showParchment, async (newVal) => {
  await nextTick()
  if (newVal && parchmentRef.value) {
    unfold(parchmentRef.value)
  }
})

// 3. ë²„íŠ¼ íš¨ê³¼
const handlePulse = () => {
  if (pulseButtonRef.value) {
    pulse(pulseButtonRef.value)
  }
}

const handleShine = () => {
  if (shineButtonRef.value) {
    shine(shineButtonRef.value)
  }
}

// 4. ì¹´ë“œ ë’¤ì§‘ê¸°
const handleCardFlip = () => {
  if (!cardRef.value) return

  if (!isCardFlipped.value) {
    flip(cardRef.value, () => {
      isCardFlipped.value = true
    })
  } else {
    flipBack(cardRef.value, () => {
      isCardFlipped.value = false
    })
  }
}

// 5. ì¹´ìš´í„° ì• ë‹ˆë©”ì´ì…˜
const animateCounter = () => {
  if (!counterRef.value) return

  const newGold = currentGold.value + Math.floor(Math.random() * 1000) + 500
  animateValue(counterRef.value, currentGold.value, newGold, 1)
  currentGold.value = newGold
}

// 6. ì „íˆ¬ ì´í™íŠ¸
const handleShake = () => {
  if (battleTargetRef.value) {
    shake(battleTargetRef.value)
  }
}

const handleFlash = () => {
  if (battleTargetRef.value) {
    flash(battleTargetRef.value, '#ff4444')
  }
}

const handleCritical = () => {
  if (battleTargetRef.value) {
    criticalHit(battleTargetRef.value)
  }
}

// 7. ë¦¬ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜
let nextId = 4
const addItem = () => {
  const generals = ['ì—¬í¬', 'ì¡°ì¡°', 'ìœ ë¹„', 'ì†ê¶Œ', 'ì œê°ˆëŸ‰', 'ì‚¬ë§ˆì˜', 'ë™íƒ', 'ì›ì†Œ']
  const randomGeneral = generals[Math.floor(Math.random() * generals.length)]
  items.value.push({
    id: nextId++,
    name: `ì¥ìˆ˜ - ${randomGeneral}`,
  })
}

const removeItem = () => {
  if (items.value.length > 0) {
    items.value.shift()
  }
}

const removeSpecificItem = (id: number) => {
  items.value = items.value.filter((item) => item.id !== id)
}
</script>

<style scoped>
.preserve-3d {
  transform-style: preserve-3d;
}
</style>
